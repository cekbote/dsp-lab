#include <arduinoFFT.h>
arduinoFFT FFT = arduinoFFT();
float data[300] = {-372.3628292,50.75906574,499.6210468,-336.9832284,-194.504521,-570.4131983,-129.7377686,560.0176664,-162.6301843,-241.049091,-345.3768694,-246.2627394,-532.3337975,-454.1922526,-617.5859731,502.7867022,302.4188989,-235.1789052,-215.4168262,-407.4876842,681.9321887,237.5584422,-231.6507305,-207.6717746,-539.4690781,510.0380345,569.1028258,-209.1779718,-117.5640572,-545.5633154,129.7289655,544.0285014,-221.9785502,-219.3977602,-409.6245983,-53.15070686,-524.5237492,-429.7457311,-687.3721612,112.2270592,155.5156477,-445.3194908,-260.988726,-653.9042776,267.1661915,320.2862136,-327.9218545,-186.6943664,-593.6471656,236.3833206,618.3802148,-193.6722552,-118.3165144,-521.6362812,104.001695,697.6731799,-135.4057213,-125.6024568,-447.1692011,-177.5848674,779.727025,44.77895239,-186.704134,-329.4899044,-416.5215007,606.8871171,175.9757746,-276.3665516,-243.3171493,-584.2947178,323.5642996,412.5329016,-317.7966551,-194.9143586,-608.4013166,43.98688969,450.3668628,-310.8877823,-249.5174339,-531.2441349,-336.9276643,603.9989054,22.88647289,-249.2701958,-283.0982045,-521.2360918,465.8596853,417.0870942,-223.4539054,-127.192763,-524.6455618,313.4949285,599.5930045,-206.8215434,-144.1229739,-527.4752016,-55.83263757,682.6191464,-84.033312,-198.5712584,-361.9537461,-457.9616445,557.6493688,242.7575051,-266.1135601,-213.8236372,-556.24835,332.4495136,302.499605,-333.2363737,-213.5981909,-610.5703529,25.74520944,561.2826499,-239.5299474,-193.7430017,-496.0222578,-218.5595457,604.5518599,-58.64324522,-212.6026756,-323.252457,-445.2422719,633.6913679,413.1880184,-169.288578,-107.617096,-479.3521203,319.4443227,635.3535822,-188.4962698,-126.7695867,-520.3712187,17.20231648,642.430029,-160.8179634,-162.8002053,-448.7397069,-234.6895348,674.4952485,-1.233956521,-208.1571117,-326.0423109,-439.3987654,573.1487589,204.8782082,-280.7233677,-228.9075206,-598.1363211,216.3079339,512.1277748,-260.7779505,-182.9745671,-519.8452394,-191.1325117,643.0931245,-43.92780173,-183.3742364,-336.2709097,-361.5423529,684.94201,271.46637,-163.6920349,-155.6494209,-464.8464164,517.0683594,497.0701591,-219.2874445,-147.7903479,-551.7472694,89.86154638,649.8993594,-169.2524534,-147.3279929,-463.1070207,-167.5600108,679.2028866,-95.35339172,-140.8059371,-425.5503589,194.1651403,-56.30059363,-344.4887429,-444.1835674,-211.0468417,247.3329856,-453.1318352,-275.7780006,-595.2578987,375.2374235,167.109732,-326.79802,-218.6305824,-570.2239094,513.9062141,664.966957,-115.7864814,-39.19240046,-437.6509235,248.1242884,854.1820392,-17.65190207,-99.13074265,-413.9399155,-189.4425751,776.8956783,67.81046605,-204.8196023,-316.8406599,-470.6797157,587.1638105,165.0532388,-220.9171849,-299.0803246,-282.3362929,-459.6964612,-476.0025286,-657.8846874,-36.28866976,611.095672,-270.0451442,-149.1496706,-552.7027601,-18.38833275,628.6379552,-194.1063973,-186.4013611,-460.0994276,-303.608706,715.171076,95.71312624,-196.2770219,-251.6015469,-448.5401135,617.0087294,448.7185764,-167.2101932,-95.96385438,-509.8408181,244.6564001,762.3511787,-101.0471042,-93.99502927,-441.8257657,-104.8673041,658.801781,-97.32354932,-228.7822057,-387.2044083,-471.9132075,538.8679212,148.5593336,-312.2890566,-244.1063443,-584.2857781,355.6797579,273.8099323,-259.2010529,-283.3043745,-291.3239989,-383.2092496,-515.3422463,-589.2413816,-318.4183185,701.2290534,-136.5587372,-146.0439276,-474.2268312,-53.24573525,626.5057709,-166.8540946,-209.8942913,-310.2995729,201.2068187,-359.9838455,-292.7140686,-531.5839014,479.3513229,452.7608323,-203.9984283,-109.0943937,-518.1939586,519.4449443,596.2184343,-182.8452654,-97.82411752,-528.3324741,280.6126544,613.5763384,-228.1419821,-137.2342068,-550.8750172,3.511930956,583.5717872,-223.8816207,-213.8729198,-464.0276534,-342.5752281,638.7791726,62.12691402
};
float p = 0;
double X[512];
float N = 512;
double average = 0;
double x_mag_resp[512];
float Pi = 3.14159;
float inex;
float peak;
float PR = 0;
const uint16_t samples = 512;
const double samplingFrequency = 10;
double vReal[512];
double vImag[512];
double respReal[512];
double respImag[512];
double resp[512];
double resp_fft_mag[512];
double ppgReal[512];
double ppgImag[512];
double ppg[512];
double ppg_fft_mag[512];
double index_ = 0;
double data_[512];


void setup() {
  // put your setup code here, to run once:
  Serial.begin(9600);

}

void loop() 
{
  // Populating the values of x with zeros
  for (int i = 0; i < N; i++)
  {
    vReal[i] = 0;
    vImag[i] = 0;
    }
  

  // Moving Average
  for (int i = 0; i< 300; i++)
  { 
    p = 0;
    if (i<8)
      {for(int k=0; k<i; k++)
        {p += data[i-k];
          }
        }
    else
    {for(int j=0; j<8; j++)
      {
        p += data[i-j];
        }
      }
    vReal[i] = p;
    average += vReal[i];
  }

  average = average / 512;

  for (int i = 0; i < 512; i++)
  {
    vReal[i] -= average;
    data_[i] = vReal[i];
    }


  // Computing the FFT
  FFT.Windowing(vReal, samples, FFT_WIN_TYP_HAMMING, FFT_FORWARD);  /* Weigh data */
  FFT.Compute(vReal, vImag, samples, FFT_FORWARD); /* Compute FFT */

  
  // Filtering
  index_ = 0.5 * 512 / samplingFrequency;
  for(int n = 0; n <N; n++)
  {
    if (n < index_ + 1 || n > (512 - index_))
    {
      ppgReal[n] = 0;
      ppgImag [n] = 0;
      respReal[n] = vReal[n];
      respImag[n] = vImag[n];
      }

      else
      {
        respReal[n] = 0;
        respImag [n] = 0;
        ppgReal[n] = vReal[n];
        ppgImag[n] = vImag[n];
        }
    }

    // Index

    for (int n = 1; n < index_; n++)
    { if (peak < sqrt(respReal[n] * respReal[n] + respImag[n] * respImag[n]));
      {
        peak = sqrt(respReal[n] * respReal[n] + respImag[n] * respImag[n]);
        inex = n;
        }
      }


    

//   Printing the Freq Plots
  for (int n = 0; n < N; n++)
  {
    Serial.println(sqrt(vReal[n] * vReal[n] + vImag[n] * vImag[n]));
    Serial.print(',');
    Serial.print(sqrt(ppgReal[n] * ppgReal[n] + ppgImag[n] * ppgImag[n]) );
    Serial.print(',');
    Serial.println(sqrt(respReal[n] * respReal[n] * respImag[n] * respImag[n])/10000.0);
//    Serial.print(',');
//    Serial.println(inex / 512 * 10 * 60);
  }

  // Printing the Time Plots
  FFT.Compute(respReal, respImag, samples, FFT_REVERSE);
  FFT.Compute(ppgReal, ppgImag, samples, FFT_REVERSE);
  FFT.ComplexToMagnitude(respReal, respImag, samples);
  FFT.ComplexToMagnitude(ppgReal, ppgImag, samples);
  FFT.ComplexToMagnitude(vReal, vImag, samples);
    for (int n = 0; n < N; n++)
  {
    
    Serial.print(sqrt(vReal[n] * vReal[n] + vImag[n] * vImag[n])/ 5.0);
    Serial.print(',');
    Serial.print(sqrt(ppgReal[n] * ppgReal[n] + ppgImag[n] * ppgImag[n]) * 10 );
    Serial.print(',');
    Serial.println(sqrt(respReal[n] * respReal[n] * respImag[n] * respImag[n]));
  }
}
  
